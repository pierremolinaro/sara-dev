//---------------------------------------------------------------------------*
//                                                                           *
//                           File 'sara_main.cpp'                            *
//         Generated by version GALGAS_BETA_VERSION (LL(1) grammar)          *
//                       may 25th, 2006, at 15h36'58"                        *
//                                                                           *
//---------------------------------------------------------------------------*

//--- START OF USER ZONE 1


//--- END OF USER ZONE 1

#include "utilities/F_DisplayException.h"
#include "utilities/MF_MemoryControl.h"
#include "time/C_Timer.h"
#include "generic_arraies/TC_UniqueArray.h"
#include "command_line_interface/F_Analyze_CLI_Options.h"
#include "command_line_interface/mainForLIBPM.h"
#include "command_line_interface/C_builtin_CLI_Options.h"
#include "command_line_interface/C_CLI_OptionGroup.h"
#include "galgas/C_galgas_CLI_Options.h"
#ifdef TARGET_API_MAC_CARBON
  #include <SIOUX.H>
#endif

#ifdef COMPILE_FOR_WIN32
  #ifdef __MWERKS__
    #include <WINSIOUX.H>
  #endif
#endif
#include "sara_cli_options.h"

//---------------------------------------------------------------------------*

#include "sara_main.h"

//---------------------------------------------------------------------------*

class C_options_for_sara_main : public C_CLI_OptionGroup {
//--- Constructor
  public : C_options_for_sara_main (const bool inAcceptsDebugOption) ;

//--- Included options
  private : C_builtin_CLI_Options mBuiltinOptions ;
  private : C_galgas_CLI_Options mGalgasOptions ;
  private : sara_cli_options mOptions_sara_cli_options; 
} ;

//---------------------------------------------------------------------------*
//                                                                           *
//                   C_options_for_sara_main  CONSTRUCTOR                    *
//                                                                           *
//---------------------------------------------------------------------------*

C_options_for_sara_main::
C_options_for_sara_main (const bool inAcceptsDebugOption)
:mBuiltinOptions (inAcceptsDebugOption) {
  add (& mBuiltinOptions) ;
  add (& mGalgasOptions) ;
  add (& mOptions_sara_cli_options) ;
}

//---------------------------------------------------------------------------*
//                                                                           *
//                          C O N S T R U C T O R                            *
//                                                                           *
//---------------------------------------------------------------------------*


sara_main::
sara_main (const C_galgas_io_parameters & inIOparameters COMMA_LOCATION_ARGS) :
mScannerPtr_ (NULL), mTerminalIO (inIOparameters) {
  mSourceFileExtension_ = "sara" ;
  mScannerPtr_ = NULL ;
  macroMyNew (mScannerPtr_, sara_scanner (& mTerminalIO COMMA_THERE)) ;
  C_GGS_Object::attachPointer (mScannerPtr_ COMMA_HERE) ;
}

//---------------------------------------------------------------------------*
//                                                                           *
//                           D E S T R U C T O R                             *
//                                                                           *
//---------------------------------------------------------------------------*


sara_main::
~sara_main (void) {
  macroDetachPointer (mScannerPtr_, sara_scanner) ;
}

//---------------------------------------------------------------------------*
//                                                                           *
//                       D O    C O M P I L A T I O N                        *
//                                                                           *
//---------------------------------------------------------------------------*

void sara_main::
doCompilation (const C_String & inSourceFileName_,
               sint16 & returnCode) {
  C_Timer timer ;
  try{
    if (mTerminalIO.versionModeOn ()) {
      ::printf ("Reading '%s'\n", inSourceFileName_.cString ()) ;
    }
    mScannerPtr_->resetAndLoadSourceFromFile (inSourceFileName_) ;
    _beforeParsing () ;
    sara_grammar grammar_ ;
    grammar_.startParsing_ (*mScannerPtr_) ;
    if (mTerminalIO.getErrorTotalCount () == 0) {
      _afterParsing () ;
    }
    ::printf ("Analysis of '%s' completed. ", mScannerPtr_->sourceFileName ().lastPathComponent ().cString ()) ;
    switch (mTerminalIO.getErrorTotalCount ()) {
    case 0 :
      ::printf ("No error, ") ;
      break ;
    case 1 :
      ::printf ("1 error, ") ;
      returnCode = 1 ; // Error code
      break ;
    default :
      ::printf ("%ld errors, ", mTerminalIO.getErrorTotalCount ()) ;
      returnCode = 1 ; // Error code
      break ;
    }
    switch (mTerminalIO.getWarningsCount ()) {
    case 0 :
      ::printf ("no warning") ;
      break ;
    case 1 :
      ::printf ("1 warning") ;
      break ;
    default :
      ::printf ("%ld warnings", mTerminalIO.getWarningsCount ()) ;
      break ;
    }
    timer.stopTimer () ;
      co << " (" << timer << ").\n" ;
  }catch (const C_TextReadException & inFileReadError) {
    ::printf ("Error : %s\n", inFileReadError.what ()) ; // Error when reading source file
    returnCode = 1 ;
  }
}

//---------------------------------------------------------------------------*

int mainForLIBPM  (const int argc, const char * argv []) {
  sint16 returnCode = 0 ; // No error
//--- Input/output parameters
  C_options_for_sara_main options (false) ;
  C_galgas_io_parameters IOparameters  (& options) ;
  #ifndef DO_NOT_GENERATE_CHECKINGS
    IOparameters.mCompilerVersion = "version 1.4.0" " [debug]" ;
  #else
    IOparameters.mCompilerVersion = "version 1.4.0" ;
  #endif
  IOparameters.mMaxErrorsCount = 100 ;
  IOparameters.mMaxWarningsCount = 100 ;
  TC_UniqueArray <C_String> sourceFilesArray ;
  F_Analyze_CLI_Options (argc, argv,
                               "version 1.4.0",
                               options,
                               sourceFilesArray,
                               "sara",
                               IOparameters.mCocoaOutput) ;
  #ifdef SIOUX_IS_IMPLEMENTED
    SIOUXSettings.asktosaveonclose = options.boolOptionValueFromKeys ("generic_cli_options",
                                                                      ASK_TO_SAVE_ON_CLOSE,
                                                                      false) ;
  #endif
  try{
    sara_main * compiler = NULL ;
    macroMyNew (compiler, sara_main (IOparameters COMMA_HERE)) ;
	  compiler->_prologue () ;
    for (sint32 i=0 ; (i<sourceFilesArray.count ()) && (returnCode == 0) ; i++) {
      compiler->doCompilation (sourceFilesArray (i COMMA_HERE), returnCode) ;
    }
	  compiler->_epilogue () ;
    macroMyDelete (compiler, sara_main) ;
	  #ifndef DO_NOT_GENERATE_CHECKINGS
      C_GGS_Object::checkAllObjectsHaveBeenReleased () ;
    #endif
  }catch (const M_STD_NAMESPACE exception & e) {
    F_default_display_exception (e) ;
    returnCode = 1 ; // Error code
  }catch (...) {
    F_default_display_unknown_exception () ;
    returnCode = 2 ; // Error code
  }
  return returnCode ;
}

//---------------------------------------------------------------------------*

//--- START OF USER ZONE 2

void sara_main::_prologue (void) {
}

void sara_main::_epilogue (void) {
}

//--- END OF USER ZONE 2


